---
title: "The Network Layer"
date: 2020-02-19T00:30:18+09:00
tags: ["network"]
---

# INTRO 

 매번 네트워크 공부는 해야지 해야지 하면서 미루게 된다. 최근에 소켓 통신 프로그래밍을 하게 될 기회가 생겼는데 이때서야 그제껏 네트워크 공부를 미뤄왔던 내 자신을 반성해본다.. 네트워크 뿐만 아니라 다른 과목도 마찬가지다.  다 알면 좋은데 귀찮은 것들 투성이다.

 밑바닥부터 시작해 네트워크의 모든 부분을 이해하고 넘어가면 참 좋을 것 같지만 그만큼 만만한 과목이 아닌 것도 알고, 그정도의 전문성을 가지고 싶지는 않았다. 학부때 꼭 네트워크 수업을 들어보고 나왔어야 했다. 중요한 분야라는 건 그 당시에도 알고있었고 심지어 수강신청도 했지만 첫 수업만 듣고 나와버렸다. 중간고사, 기말고사 기간에 ppt 만 달달 외우게 할 수업인게 너무 뻔히 보여서.. 솔직히 말해서 첫수업만에 교수님의 무능이 너무 뻔히 보였다. 

 어딜가서 네트워크 잘 모른다는 소리만 안듣게 공부를 시작하려고 했는데 네트워크 강의가 생각보다 잘 없다. 프로그래밍 언어에 대한 입문 강의는 참 많은데 네트워크에 대해서는 사람들이 많이 궁금해 하지는 않는 것 같다.  인프런의 강의는 입문용 치고는 너무 비싼 것 같았고  coursera 에서 구글이 제공해주는 강의가 있는 것을 확인했고 이걸 끝까지 완주해보기로 했다. 

 이전에 머신러닝 강의를 너무 잘 들어서 coursera 강의면 일단 신뢰가 잘 간다.  코딩으로 테스트를 보는 과정까지 있었으면 좋았겠지만 아쉽게도 그런 과정은 없는 것으로 보인다.  입문 강의다 보니 간단간단하게 개념 정리를 하는 차원에서 노트도 남겨본다. 

# CONTENTS

## Introduction to Network

 우리가 매일같이 사용하는 스마트폰, 컴퓨터 모두 네트워크가 연결되었다. 당연하다는 듯이 요금만 내면 아무리 먼거리에 있는 사람과도 통화를 하고 카카오톡으로 메세지를 주고 받을 수 있고, 직접 방송을 송출하는 사람의 영상을 볼 수도 있으며, 여러 서버에 내 아이디와 패스워드, 쇼핑리스트 같은 내용을 저장해두고 필요할때마다 찾아본다. 당연하다고 하면 당연한 거지만 도대체 왜 그런게 가능할까? 

 한번이라도 의문을 가져보면 그때부터는 모든게 다 미스테리에 빠진다. 유튜브는 어떻게 그 많고 많은 스마트폰중에 지금 동영상을 클릭한 스마트폰이 바로 나의 스마트폰인걸 알고 그걸 또 어떻게 무선으로 전달하지? 내 폰에는 아무것도 연결이 안되어있는데 .. 

  사람과 사람이 대화하는 것을 먼저 생각해보자. 누군가와 대화를 나눌때 우리는 보통 인사를 먼저 주고 받기도 하고, 아주 친한 사이인 경우 그냥 다짜고짜 본론으로 들어가기도 한다. 한 사람한테만 말하는 것이 아니라 여러 사람한테 말하는 경우도 있을 것이고, 방금 전의 대화를 잘 못들었다면 다시 말해달라고 요청하기도 한다. 다른 사람이 이야기를 하는 동안에는 내 이야기를 하기보다는, 그사람의 말을 끝까지 듣고 난뒤 그에 대한 내 생각을 말한다. 알게 모르게 우리는 서로 잘 소통하기 위해 암묵적인 약속을 지키고 있다. 

 컴퓨터나 다른 네트워크 기기들도 마찬가지다. 서로 잘 소통을 하기 위해서는 어떤 "약속"이 필요하다. 한번쯤 들어본 프로토콜이 이런 역할을 한다.

### Protocol

- 컴퓨터끼리 서로 잘 소통하기 위해 지켜지는 표준들의 집합
- 서로 대화하기 위한 약속

### Computer Networking

- 컴퓨터끼리 소통하는 방법에 대한 통칭 

## The TCP/IP 5 Layer Model 

  보통 OSI 7 layer 모델과 함께 가장 많이 언급되는 모델이다. 여기서 모델이라 함은, 컴퓨터 네트워크가 어떻게 구성되어있는지를 설명하는 방법에 지나지 않는다.  TCP/IP 5 layer 모델과 OSI 7 layer 모델은 같은 대상을 조금 다르게 설명할 뿐 하고자 하는 일은 같다.  강의에서 TCP/IP 5 layer 모델을 주로 하기 때문에 앞으로도 이 내용으로 정리하고자 한다. 

![tcp-ip-5-layer](/images/tcp-ip-5-layer.png)

### Physical layer

- 케이블의 연결이나 전원 같은 물리적으로 데이터를 전송하는 계층

### Data Link Layer

- **Network Interface Layer**, **Network Access Layer** 라고 부르기도 한다. 
- Physical layer 의 기능들을 공통의 인터페이스로 추상화하는 단계
- 서로 다른 네트워크 기기들이 신호를 해석할 수 있는 약속, 프로토콜이 필요한 첫번째 Layer다. 
- 많은 프로토콜이 있지만 **Ethernet** 과 **Wifi** 가 가장 보편적인 프로토콜이다. 

### Network Layer 

- 서로 다른 네트워크가 라우터를 통해 통신할 수 있도록 한다. 
- 라우터를 통해 같이 연결된 네트워크의 공동체를 **인터넷**이라고 한다. 
- Data Link Layer 와의 차이점은 Data Link Layer 는 하나의 Link 에서 데이터를 주고 받지만 Network Layer 에서는 여러 네트워크를 거쳐 데이터를 주고 받는다는 차이가 있다. 
- 여기서 가장 많이 쓰이는 프로토콜이 IP (Internet Protocol) 이다. 

### Transport Layer

- 구체적으로 어떤 프로세스가 데이터를 가져가야 하는지 결정해준다. 
- TCP 와 UDP 가 가장 대표적인 프로토콜이다.  대표적인 차이점은 UDP 는 데이터의 무결성을 보장하지 않는다는 것

### Application Layer

- 웹 브라우저와 이메일 프로그램과 같이 어플리케이션 마다 다른 약속(프로토콜)을 가질 수 있다.  
- http smtp 와 같은 프로토콜이 있다.

직관적으로 아래의 그림과 같은 역할을 한다. 

![tcip-ip-5-layer-intuition.jpeg](/images/tcp-ip-5-layer-intuition.png)

## The Basics of Networking Devices

 프로그래밍을 하다가 네트워크 관련 문제가 발생했을 때 꼭 원인이 프로그램에 있다고 단정 지을 수는 없다. 여러가지 요인이 있을 수 있겠지만 당연하게도 하드웨어가 문제가 있을 수도 있다. 전문가 만큼은 아니더라도 간단하게 나마 어떤 하드웨어가 어떤 역할을 하는지 정도는 정리해둬서 나쁠게 없다. 

### Cables

#### Copper cable

- 전압의 변화로 0, 1을 구분할 수 있다. 
- 케이블이 보통 한쌍이 엮여있는 형태인데 가장 보편적인 형태가 Cat5, Cat5e, Cat6 이다. 
- 내부의 케이블이 어떻게 구성되어있냐에 따라 데이터의 전송 속도나 안정성에 영향을 미친다. 
- 최신의 기술일수록 crosstalk 을 막기 위해 개선되어왔다. 

#### Fiber cable

- 사람 머리 정도 굵기의 유리로 된 케이블
- 빛의 펄스로 0, 1을 구분한다. 
- 주변에 자기적으로 영향을 받는 경우 copper 보다 나은 선택이 될 것이다. 
- copper 보다 빠르지만 비싸고 물리적으로 손상받기 쉽다.
- 데이터 손실 없이 copper 보다 더 멀리 데이터를 전송할 수 있다. 

- CrossTalk 
  - 한 선에서의 전기적 신호가 다른 선에서 감지 될 때
  - 이로인해 에러가 발생하기 마련 

### Hub and Switch

 Cable 은 point-to-point 통신만 가능하게 한다. 

#### Hub

- 여러 컴퓨터를 동시에 연결하게 해주는 Physical layer 의 기기
- 각각의 컴퓨터로 같은 데이터가 전송되는데, 전송된 데이터를 사용하느냐 마느냐는 각각의 컴퓨터가 결정해야할 사항이다. 
- 필요없는 통신을 해야하기 때문에 오버헤드는 물론 문제가 생기기도 한다. 대표적인 것이 **Collision domain**

#### Switch 

- Hub 와 달리 Data Link Layer 의 기기이다. 
- Ethernet 과 같은 프로토콜을 이해할 수 있고, 연결된 여러 기기 중 정확히 어떤 기기에 데이터를 전송해야하는지 알고 있다. 
- 네트워크의 Collision domain과 같은 문제를 거의 해결한다. (완전히 해결하지는 못하는 모양?)
- 성능적으로 Hub 보다 더 좋다. 

#### Collision domain

- 한 순간에 하나의 기기만 통신할 수 있는 네트워크 부분 
- 여러 시스템이 동시에 데이터를 전송하려고 하면 전기적인 신호가 서로 간섭될 수 있다. 

#### LAN : Local Area Network

- Hub와 Switch는 하나의 네트워크 안에서 기기들을 연결할때 사용된다. 
- 이 때 이 하나의 네트워크를 보통 LAN 이라고 한다. 
  - 스타에서의 LAN 이 이런 LAN 이었구나.. 이래서 인터넷 연결 안되도 게임 할 수 있었던 거구나

### Router

- 독립적인 네트워크 사이에서 데이터를 어떻게 전송하는지 아는 기기 
- Network Layer 에서 동작한다. 
- 내부에 테이블을 IP 주소를 저장하곤 한다. 
- core router 라고하는 특수한 장비는 보통의 router 보다 훨씬 많은 IP를 가지고있고 많은 일을 해준다. 
- router 끼리는 **BGP**(Border Gateway Protocol) 이라는 프로토콜을 통해 데이터를 주고 받는다.  이를 통해 트래픽을 가장 효율적인 경로로 가져온다. 
- 단순히 집에서 인터넷만 해도 데이터는 라우터 들을 통해 멀리 멀리 알아서 잘 왔다갔다 한다. 

### Servers and Clients

#### Server 

- 데이터를 요청하는 무언가에게 데이터를 전송하는 노드

#### Client 

- 연결을 시도하고, 데이터를 요청하는 노드

<br/>

## The Data Link Layer 

 최근에 대부분의 네트워크 기기들이 무선 연결을 사용하지만 데이터 센터와 같은 곳에서는 여전이 유선 연결을 사용한다. 유선으로 연결한 대부분의 네트워크 장비들은 Ethernet 프로토콜을 따른다. 

 Data Link Layer의 가장 주된 목적은  Physical Layer의 구체적인 구현에 대해 추상화를 하는 것이다. 

### Ethernet and MAC Address 

#### Ethernet 

- CSMA / CD (Carrier sense multiple access with collision detection)

  - 통신 채널이 언제 사용가능한지 확인하고 가능할때만 데이터를 전송하게 한다.
  - 채널에 데이터가 전송되고 있지 않으면 노드는 데이터를 보낸다.
  - 어떤 컴퓨터가 데이터를 보내고 있다면 이를 확인하고 데이터를 보내지 않는다.
  - 이런 충돌과 관련된 모든 기기들은 랜덤한 짧은 구간동안 대기한다.  이를 통해 다음에 충돌이 또 일어나지 않도록 한다.

#### MAC Address (Media Access Control Address)

- 네트워크 기기에 부여되는 고유한 48bit의 주소(globally)

- 첫 3바이트는 OUI 로 제조사별로 부여된다. 
- 다음 3바이트는 제조사가 부여한다. 

 Ethernet 은 MAC address 를 사용한다. 보낸 기기와 받는 기기를 이때 명시함으로써 collision domain 과 같은 네트워크에서도 각각의 노드들은 어떤 트래픽이 자신의 트래픽인지 알 수 있게 된다. 

### Unicast, Multicast, Broadcast

#### Unicast

- 하나의 노드에게만 보내는 통신
- ethernet destination address의 첫 바이트의 첫 비트(LSB)가 0이다.

#### Multicast

- 네트워크의 모든 노드에게 보내는 통신
- 해당 통신이 수락될지 거절될지는 해당 통신을 받은 노드에서 결정한다.
- ethernet destination address의 첫 바이트의 첫 비트(LSB)가 1이다.

#### Broadcast

- 네트워크의 모든 노드에게 보내는 통신
- 이를 통해 네트워크 내부의 노드들이 서로에 대해서 알게 된다.
- ethernet destination address의 주소가 FF:FF:FF:FF 의 형태다. 

<br/>

### Dissecting an Ethernet Frame 

![ethernet-frame](/images/ethernet-frame.jpeg)

#### Data Packet 

- 네트워크 링크를 통해 전달되는 바이너리 데이터의 한 집합
- 여러 Layer 에 걸쳐 통용되는 단어임

#### Ethernet Frame 

- Ethernet level 에서의 Data Packet 
- 데이터의 구체적인 순서와 크기가 정해져 있다.

**Preamble**

- 8 바이트이며 자체적으로 두 구간으로 나뉘어져 있다.
- 첫 7바이트는 0과 1이 번갈아가면서 등장하는데 네트워크 프래임간의 buffer 로 사용되기도 하고 network interface가 내부 시간을 동기화하는데 사용하기도한다. 
- 마지막 1바이트는 **SFD** (Start Frame Delimiter) 라하고 받는 노드에게 Preamble이 끝났음을 알린다. 

**Destination Address / Source Address**

- 말 그대로 주소를 담고 있는 부분으로 MAC address 가 저장되어있다. 

**Ether-type** 

- 2바이트로 어떤 프로토콜인지 나타내기 위해 사용된다.
- 이 위치에 VLAN header 가 올 수 있으며 그럴 경우 Ether-type 은 VLAN header 뒤로 온다.

**VLAN** (Virtual LAN)

- 하나의 기기이서 여러 논리적인 LAN 주소를 가질 수 있게 한다.
- VLAN은 보통 다른 종류의 트래픽을 분류하기 위해 사용된다. 

**PayLoad**

- 46-1500 바이트 
- Transport Layer, Application Layer 에서 실질적으로 운반되는 데이터

**FCS**(Frame Check Sequence)

- 4바이트. 전체 Ethernet 프레임에 대한 checksum
- **CRC**(cyclical redundancy check) 를 이용해 검증한다. 

FCS의 체크섬은 패킷을 송신할때 송신자가 한번, 수신할때 수신자가 한번 계산하게 된다. 만약 수신자가 체크섬을 계산했을때 다른값을 얻은 경우, 데이터는 전송 과정중에 손상을 받은 것으로 간주하고, 전달받은 데이터를 버린다.

Ethernet 프로토콜은 전송받은 데이터의 무결성을 검증하지만 데이터를 다시 요청하거나 재전송하는 로직은 포함되지 않는다. Ethernet 프로토콜은 단지 데이터에 손상이 있었음을 알리며, 이후의 동작은 Transport Layer 나 Application Layer의 상위 Layer에서 지정한대로 동작하게 된다. 

<br/>

# Referenced

[computer-networking](https://www.coursera.org/learn/computer-networking)