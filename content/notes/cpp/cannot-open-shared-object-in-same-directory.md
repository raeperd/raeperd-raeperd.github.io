---
title: "Cannot Open Shared Object in Same Directory"
date: 2020-11-02
tags: ["cpp", "bug"]
---

윈도우에서 동적라이브러리(.dll)를 사용하는 실행파일은 해당 dll이 존재하지 않으면 자신과 같은 디렉토리에 그 dll이 존재하는지 확인하고, 실행 할 수 있다. (물론 실행시켜주는 주체는 Windows일 것, implicit link에 한해)

윈도우 환경 개발이 익숙하면, 리눅스에서도 똑같이 이런 현상이 재현될 것이라 생각할 수 있는데, 그렇지 않았다. 리눅스는 `LD_LIBRARY_PATH` 라는 환경변수에 따라, 라이브러리가 이 경로에 있는 경우 실행해준다.

당장 리눅스에서도 같은 디렉토리의 동적라이브러리는 실행할 수 있으면 좋겠다면, 아래와 같이 실행하면 된다.

```bash
$ LD_LIBRARY_PATH=. ./some_program
```

개발하는건 프로그래머지만 사용하는건 사용자다. 사용자가 이런 부분까지 이해해주고 실행하길 바라는건 너무 큰 욕심이다.

빌드 할때 부터 이런 옵션을, cmake로 빌드하면서 줄 수 있는데 아래와 같은 옵션을 주면된다.

```cpp
set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -Wl,-rpath='$ORIGIN'")
```

 물론 이렇게 하는 건 modern cmake 에서는 안티 패턴이다. 개선할 방법이 있을까? 잘 모르겠지만 이정도는 사용자가 알아서 잘 하길 바라거나, .cmake 파일을 별도로 배포하는 수 밖에 없다.

C++ 은 참 배포하기 힘든 언어다. 요즘에는 C++ 이야말로 docker로 배포해야하는 어플리케이션이 아닐까 하는 생각이 든다.