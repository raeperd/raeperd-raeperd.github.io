---
title: "Bitcoint key format"
date: 2020-03-25
author: raeperd
tags: ["blockchain", "cryptography"]
cover:
    image: /cover/bitcoin.png
---



### INTRO

  

 비트코인에서는 디지털 키, 비트코인 주소, 디지털 서명을 통해 비트코인의 소유권이 성립됩니다. 모든 비트코인 거래에는 유효한 서명이 필요하며 이러한 서명은 유효한 디지털 키가 있어야만 가능합니다. 중앙의 관리가 없는 비트코인에서 이런 거래의 유효성을 검증하는데 공개키 암호 알고리즘이 주요하게 사용되었습니다. 

  

 거래의 유효성을 검증하는데 공개키를 사용했다는 것은 전혀 놀라울 것이 없었고, 그냥 적용하면 되겠지 하고 막연하게 생각하고 있었는데 구체적으로 어떻게 적용되는지 공부해보면 할수록 어떤 암호 알고리즘을 시스템에 적용하는게 그리 간단한 일이 아니라는 것을 알게 됬습니다. 특히 인코딩고 디코딩 관련해서 느낀점이 많아 이렇게 정리해 두려고 합니다.

  

 이번 글에서는 비트코인 시스템에서 개인키와 공개키를 저장하는 포멧에 대해 정리해보려고 합니다. (지갑 어플리케이션마다 조금 다를 수는 있음)

  

### 난수를 통한 개인키 생성

 키를 생성하는 과정 중 가장 첫 단계이자 중요한 단계로 보안이 철저한 엔트로피 소스, 곧 무작위성을 찾는 일이다. 이때, ==**암호학적으로 안전한 유사난수 생성기** **(CSPRNG)**를 사용하는 것이 중요하다. 프로그래밍 언어가 제공하는 단순한 난수생성기는 위험할 수 있다.== 이 과정에서 생성되는 난수는 예측불가능성과 재현불가능성을 만족해야만 한다. 비트코인의 난수는 OS의 난수생성기를 사용하며 이는 사용자 마우스의 움직임 등을 이용해 무작위성을 만들어 낸다. 

  

 좀 더 정확하게는 암호학적으로 안전한 엔트로피소스를 통해 생성된 무작위 비트열을 SHA256 해쉬 알고리즘에 집어넣으면 편리하게 256비트의 숫자를 생성할 수 있다. ECC에서 사용 될 수 있는 개인키의 범위는 1부터 n-1까지 인데, (타원곡선의 order가 n인 경우에 그렇다) 결과값이 n-1 보다 크다면 다른 난수를 이용해 같은 과정을 다시 시도하는 것으로 충분하다. 

  

 개인키가 생성된 이후에는 타원곡선 암호 알고리즘을 통해 공개키를 생성할 수 있다.

  

### 비트코인 주소 

  

SHA256과 RIPEMD160 해쉬, 그리고 base58check 인코딩을 이용해 다음과 같이 비트코인 주소를 생성할 수 있다. 

$ address = BASE58Check(RIPEMD160(SHA256(pubKey))$

  

### BASE58, BASE58Check

  

 많이 사용하는 BASE64 인코딩의 경우 소문자 26개와 대문자 26개, 숫자 10개, 특수문자 2개로 구성되어 있다. BASE58 인코딩의 경우는 압축표현법, 가독성, 에러감지 및 방지 등에 있어 균형을 맞추기 위한 역할을 한다. BASE58은 BASE64의 부분집합을 가지고 인코딩을 하는데 자주 실수가 발생하거나 특정 글자체에서는 동일하게 보일 가능성이 있는 몇몇 문자들은 생략한다. 곧 0(숫자 zero), O(대문자 O), l(소문자 L), I(대문자 i)와 '+', '/' 등의 부호를 쓰지 않은 BASE64라고 생각할 수 있다.  

  

 오자나 데이터 입력 오류 등에 대한 추가 보안을 설정하기 위해 BASE58의 인코딩 포멧인 BASE58Check를 이용한다. BASE58 인코딩에 검사합을 추가한 인코딩 방법인데 인코딩 된 데이터의 해시로부터 4바이트 크기의 검사합을 이용해 데이터 입력 및 타이핑 오류를 감지한다.  BASE58Check 코드와 디코딩 소프트웨어가 함께 존재하는 경우, 해당 데이터의 검사합을 계산한 후 BASE58Check 코드에 들어 있는 검사합과 비교하면 정상적인 입력이었는지를 확인할 수 있다. 

  

 특이하게도 검사합을 계산할 때, SHA256 알고리즘을 두번 거치게 되는데 이 이유는 공부가 더 필요할 듯 하다. 

  

 비트코인에서는 BASE58Check 인코딩에서 버전 접두부를 추가해 인코딩하는데 이는 인코딩 되고 있는 데이터의 포맷을 쉽게 확인할 수 있게 해준다. 유형별 접두부는 아래와 같다.

  

| 유형                    | 버전 접두부(4Byte) | BASE58 접두부 결과값 |
| ----------------------- | ------------------ | -------------------- |
| 비트코인 주소           | 0x00               | 1                    |
| Pay-to-Script-Hash 주소 | 0x05               | 3                    |
| 비트코인 테스트넷 주소  | 0x6f               | m or n               |
| 개인키 WIF              | 0x80               | 5,K,L                |
| BIP38 암호화 공개키     | 0x0142             | 6P                   |
| BIP32 확장 공개키       | 0x0488B21E         | xpub                 |

  

### 개인 키 포맷 

  

개인키는 다양한 포멧으로 저장될 수 있는데 당연하게도 같은 키라도 다양한 방법으로 인코딩 될 수 있다. 

| 유형        | 접두부 | 설명                                                         |
| ----------- | ------ | ------------------------------------------------------------ |
| HEX         | 없음   | 64개의 16진법 수                                             |
| WIF         | 5      | BASE58Check 인코딩: 버전 접두부 0x80과 32비트 검사합을 이용한 BASE58 |
| WIF -압축형 | K or L | 위와 같음. 인코딩 전 접미부 0x01 추가                        |

  

### 공개 키 포맷

  

 공개키는 여러 다른 방법으로 표현 되기도 하는데, 압축 공개키와 비압축 공개키가 주요 표현법이다. ECC에서 공개키는 한 쌍의 (x,y) 좌표로 구성된 점으로 타원곡선 상에 존재한다. 각 256비트의 두 좌표와 8비트의 접두부를 저장할 경우 총 520비트가 필요하다. 

  

### 압축 공개키 

  

 앞서 언급한대로 ECC에서 공개키는 타원곡선상의 한 점이다. 타원 곡선 또한 공개된 정보이기 때문에 x좌표만 알면 방정식 $y^2 = x^3 + 7$ mod p 를 풀어서 y좌표를 계산해 낼 수 있다. 곧 x좌표와 y좌표 모두를 저장하는 것이 아니라 하나만 저장하고 다른 하나는 계산을 통해 추론해 내는 것이 가능하다. 이런 방식으로 비트코인에서는 모든 거래의 크기를 약 50% 가량 줄이는 것이 가능하다. 

  

 여기서 접두부가 의미를 가지게 되는데 접두부 04는 비압축 공개키, 02혹은 03은 압축된 공개키를 나타낸다. 여기서 두가지 정보가 필요한 이유는 알려진 x의 좌표를 타원 곡선상에 대입하면 얻게 되는 y의 값은 +일때와 -일때 두가지로 나타나며 따라서 유일하게 결정되지 않는다. 곧 y 좌표는 생략할 수 있지만 y값의 부호는 저장해야 한다. 소수 위수를 가지는 타원 곡선에서 y좌표는 짝수이거나 홀수인데 이 값들은 양수/음수에 각각 대응된다. 곧 y값이 짝수 일때는 02, 홀수 일때는 03으로 압축 공개키를 저장함으로써 소프트웨어가 x좌표로부터 정확하게 y좌표를 추론하고 공개키를 해당 포인트의 좌표로 다시 풀 수 있도록 할 수 있다. 

  

 여기서 주의할 점 또하나가 압축 공개키로 부터 생성된 비트코인 주소와 비압축 공개키로부터 생성된 비트코인 주소는 다르다. (조금만 생각해보면 당연한 사실) 하지만 개인키는 두 가지 비트코인 주소에서 동일하다. 두가지 비트코인 주소 모두 같은 개인키로 서명하는 것이 가능하지만 엄연히 다른 주소로 인식하게 된다. 

  

### 압축 개인키



 